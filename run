#!/usr/bin/env bash
#
# Run script for bass_driven_video_gen
# Source this file from your shell RC (e.g. .zshrc or .bashrc):
#
#   source /path/to/bass_driven_video_gen/run.sh
#

# --- Resolve repo root relative to this file, not the caller (.zshrc) ---
if [ -n "$BASH_SOURCE" ]; then
  SCRIPT_PATH="${BASH_SOURCE[0]}"
elif [ -n "${ZSH_VERSION}" ]; then
  SCRIPT_PATH="${(%):-%N}"
else
  SCRIPT_PATH="$0"
fi

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# Repo root is one level up from this script file
export REPO_ROOT="$(cd "$SCRIPT_DIR" && pwd)"

# --- Constants ---
export GENERATOR_PY="$REPO_ROOT/run.py"
export VENV_DIR="$REPO_ROOT/venv/bin/python"

# --- Main function ---
musicvideo() {
  local dir="${1:-$PWD}"

  if [[ ! -d "$dir" ]]; then
    echo "error: '$dir' is not a directory" >&2
    return 1
  fi
  if [[ ! -f "$GENERATOR_PY" ]]; then
    echo "error: run.py not found at '$GENERATOR_PY'" >&2
    return 1
  fi

  # Ensure system python exists
  local sys_py
  sys_py="$(command -v python3 || command -v python)"
  if [[ -z "$sys_py" ]]; then
    echo "error: couldn't find a system Python interpreter" >&2
    return 1
  fi

  # Bootstrap venv if missing
  if [[ ! -x "$VENV_DIR" ]]; then
    echo "⚙️  Creating virtual environment at $REPO_ROOT/venv..."
    "$sys_py" -m venv "$REPO_ROOT/venv" || {
      echo "error: failed to create venv" >&2
      return 1
    }
    source "$REPO_ROOT/venv/bin/activate"
    if [[ -f "$REPO_ROOT/requirements.txt" ]]; then
      echo "📦 Installing dependencies from requirements.txt..."
      pip install --upgrade pip setuptools wheel
      pip install -r "$REPO_ROOT/requirements.txt" || {
        echo "error: pip install failed" >&2
        deactivate
        return 1
      }
    else
      echo "⚠️  No requirements.txt found in $REPO_ROOT"
    fi
  fi

  # Use venv python
  local py="$VENV_DIR"
  [[ -x "$py" ]] || py="$sys_py"

  "$py" "$GENERATOR_PY" "$dir"
}

# --- Tab completion for directories ---
_comp_musicvideo() {
  _files -/
}
if command -v compdef >/dev/null 2>&1; then
  compdef _comp_musicvideo musicvideo
fi

